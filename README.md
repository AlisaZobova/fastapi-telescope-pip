# FAST API TELESCOPE

This is a FastAPI middleware with UI dashboard for monitoring and debugging your FastAPI applications. It provides a set of tools to help you visualize and analyze the performance of your API endpoints, including request/response times, error rates, and more.

## Setup

1. Install the package using pip.
2. Create a FastAPI application and include the middleware and UI part like this:
```python
import os
from dotenv import load_dotenv

load_dotenv()

from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from fastapi.responses import FileResponse
import uvicorn
from fastapi import FastAPI, Request, status
from fastapi.responses import JSONResponse
from telescope.middleware import TelescopeMiddleware
from fastapi_pagination import add_pagination
from fastapi import APIRouter, status, Depends

from main.shared.di import get_user_id # can be replaced with your own dependency for getting auth user id
from telescope import router as telescope_router

router = APIRouter(dependencies=[Depends(get_user_id)])
router.include_router(telescope_router)

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

app.add_middleware(TelescopeMiddleware)

app.include_router(router)

add_pagination(app)

# Mount static files directory (the built Vue app)
static_dir = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))), "", "telescope/static")

app.mount("/assets", StaticFiles(directory=os.path.join(static_dir, "assets")), name="assets")


@app.get("/telescope/dashboard", response_class=FileResponse)
async def read_index():
    return FileResponse(os.path.join(static_dir, "index.html"))


@app.get("/telescope/dashboard/{catch_all:path}")
async def catch_all(catch_all: str):
    file_path = os.path.join(static_dir, catch_all)
    if os.path.exists(file_path) and not os.path.isdir(file_path):
        return FileResponse(file_path)
    return FileResponse(os.path.join(static_dir, "index.html"))



@app.exception_handler(Exception)
def global_exception_handler(request: Request, exc: Exception):
    return JSONResponse(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        content={'message': 'An unexpected error occurred'},
    )

if __name__ == '__main__':
    uvicorn.run(
        'main.cmd.main:app', host='0.0.0.0', port=8000, reload=True
    )  # use for debugging
```
3. If you want to have auth user id in requests logs, you can add a dependency to your router and add info with id to request so it can be processed by middleware later like this:
```python
from starlette.requests import Request

async def get_user_id(
    request: Request,
) -> str:
    user_id = '111'
    request.state.user_id = user_id # this is important for logs
    return user_id
```
4. Add creds (DB_USER,DB_PASS,DB_HOST,DB_PORT,DB_NAME) to db to your .env file.
5. Add migration with such methods to your migrations folder and run it.
```python
def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('log_http_requests',
                    sa.Column('id', sa.Integer(), nullable=False),
                    sa.Column('level', sa.String(), nullable=False),
                    sa.Column('request_method', sa.String(), nullable=False),
                    sa.Column('request_url', sa.String(), nullable=False),
                    sa.Column('path_params', sa.String(), nullable=False),
                    sa.Column('query_params', sa.String(), nullable=False),
                    sa.Column('headers', sa.String(), nullable=False),
                    sa.Column('request_body', sa.String(), nullable=False),
                    sa.Column('status_code', sa.Integer(), nullable=False),
                    sa.Column('response_time', sa.Float(), nullable=False),
                    sa.Column('response_body', sa.String(), nullable=False),
                    sa.Column('exception_message', sa.String(), nullable=True),
                    sa.Column('stack_trace', sa.String(), nullable=True),
                    sa.Column('user_id', sa.String(), nullable=True),
                    sa.Column('created_at', sa.DateTime(), nullable=False),
                    sa.Column('updated_at', sa.DateTime(), nullable=False),
                    sa.PrimaryKeyConstraint('id')
                    )
    op.create_table('log_db_queries',
                    sa.Column('id', sa.Integer(), nullable=False),
                    sa.Column('log_http_request_id', sa.Integer(), nullable=False),
                    sa.Column('level', sa.String(), nullable=False),
                    sa.Column('db_query', sa.String(), nullable=False),
                    sa.Column('db_query_time', sa.Float(), nullable=False),
                    sa.Column('created_at', sa.DateTime(), nullable=False),
                    sa.Column('updated_at', sa.DateTime(), nullable=False),
                    sa.ForeignKeyConstraint(['log_http_request_id'], ['log_http_requests.id'], ),
                    sa.PrimaryKeyConstraint('id')
                    )
    op.create_index(op.f('ix_log_db_queries_log_http_request_id'), 'log_db_queries', ['log_http_request_id'],
                    unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    op.drop_index(op.f('ix_log_db_queries_log_http_request_id'), table_name='log_db_queries')
    op.drop_table('log_db_queries')
    op.drop_table('log_http_requests')
    # ### end Alembic commands ###
```
6. Copy folder telescope to your project folder.
7. Update **static/config.js** with your backend url.
8. Run your FastAPI app.
9. Open your browser and go to `http://localhost:8000/telescope/dashboard` (or your own backend url) to see the dashboard.
